---
title: "第四章 网络层：数据平面"
description: ""
lead: ""
date: 2021-04-09T23:22:59+08:00
lastmod: 2021-04-09T23:22:59+08:00
draft: false
images: []
menu: 
  docs:
    parent: "computer-network"
weight: 10
toc: true
---

## 4.2 路由器工作原理

+ 路由器体系结构
  {{< img src="路由器结构.png" alt="Rectangle" class="border-0" >}}
+ 基于目的地转发
+ 通用转发

### 4.2.1 输入端口处理和基于目的地转发

+ 输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。
+ 路由器转发表采用前缀匹配的方式生成表项，对于每一个链路接口，其目的地址范围的前缀为表项中的前缀匹配。
+ 在收到分组时，路由器用分组的目的地址和表项中的前缀匹配，匹配成功则将该分组转发到对应的链路接口。
+ 当存在多个成功匹配时，采用**最长前缀匹配规则**，转发到匹配长度最长的那个链路接口。

### 4.2.2 交换

+ 经内存交换
+ 经总线交换
+ 经互联网络交换

### 4.2.3 输出端口处理

+ 输出端口处理去除已经存放在输出端口内存中的分组并将其发送到输出链路上。

### 4.2.4 何处出现排队

+ 随着队列的增长，路由器的缓存空间最终将会耗尽，并且当五内存可用于存储到达的分组时将会出现丢包。
+ 输入排队
+ 输出排队

### 4.2.5 分组调度

+ **先进先出（FIFO)**
+ **优先权排队**：
  + 将到达输出链路的分组按照优先级分成多个类，优先级高的类先传输，类内采用FIFO的方式。
  + **非抢占式优先权排队**：一旦分组开始被传输，即使此时有更高优先级的分组到达，该分组的传输也不会被打断。
+ **循环和加权公平排队**：
  + 循环排队规则：也将分组分成多个类，循环调度器在类之间轮流传输
  + 加权公平排队：和循环排队类似，但是在第$i$个类有需要发送的分组的任何时间间隔中，都能保证该类待发送的分组中有$w_i/(\sum w_j)$的部分接收到了发送服务。

## 4.3 网际协议：IPv4、寻址、IPv6及其他

### 4.3.1 IPv4数据报格式

+ IPv4数据报格式
  {{< img src="CN_4.3.1.jpg" alt="Rectangle" class="border-0" >}}
+ 版本号。这4比特规定了数据报的IP协议版本。
+ 首部长度。因为一个IPv4数据报可包含一些可变数量的选项，故需要用这4比特来确定IP数报中载荷实际开始的地方。大多数IP数据报不包含选项，所以一般的IP数据报具有20字节的首部。
+ 服务类型。服务类型比特包含在IPv4首部中，以便使不同类型的IP数据报能相互区别开来。
+ 数据报长度。这是IP数据报的总长度（首部加数据），以字节计。
+ 标识、标志、片偏移。这三个字段与所谓IP分片有关。
  标识：每个数据报+1，一个数据报的各个分片相同
  标志：最后一个为0，其他为1
  片偏移：以64bit为单位。
+ 寿命（TTL）。寿命字段用来确保数据报不会永远在网络中循环。
+ 协议。该字段通常仅当一个IP数据报到达其最终目的地时才会有用。
+ 首部校验和。首部校验和用于帮助路由器检测收到的IP数据报中的比比特错误。
+ 源和目的IP地址。当某源生成一个数据报时，它在源IP字段中插入它的IP地址，在目的IP地址字段中插入其最终目的地的地址。
+ 选项。选项字段允许IP首段被扩展。
+ 数据。

### 4.3.2 IPv4数据报分片

+ 一个链路层帧能承载的最大数据量叫最大传送单元(MTU)
+ 链路层协议的MTU严格地限制着IP数据报的长度
+ 大的IP数据报被分片成两个或更多个小的IP数据报，这些较小的数据报称为片
+ 数据报的重新组装工作放到端系统中，而不是放到网络路由器中

### 4.3.3 IPv4编址

+ 主机与物理链路之间的边界叫做接口。
+ 一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。
+ IP地址采用**点分十进制记法**
+ 互联主机的接口和一个路由器接口的网络形成一个子网。
+ 子网掩码指示32比特中最左侧$x$比特定义了子网地址
+ 为了确定子网，分开主机和路由器的每个接口，产生集个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫做一个子网。
+ 因特网的地址分配策略被称为**无类别域间路由选择**
+ 形式为$a.b.c.d/x$的地址的$x$最高比特构成了IP地址的网络部分，并且经常被称为该地址的前缀（或网络前缀)
+ 当一台主机发送一个目的地址为255.255.255.255的数据报时，该报文会交付给同一个网络中的所有主机。路由器也会有选择地向邻近的子网转发该报文。

#### 1.获得一块地址

+ 为了获取一块IP地址用于一个组织的子网内，某网络管理员也许首先会与他的ISP联系，该ISP可能会从已分给它的更大地址块中提供一些地址。

#### 2.获取主机地址：动态主机配置协议

+ 系统管理员通常手工配置路由器中的IP地址。主机地址也能手动配置，但是这项任务目前更多的是使用动态主机配置协议（DHCP）来完成。
+ 除了主机IP地址分配外，DHCP还允许一台主机得知其他信息，例如它的子网掩码、它的第一跳路由器地址与它的本地DNS服务器的地址。
+ 第一跳路由器地址又称为默认网关。
+ DHCP协议的4个步骤：
  1. DHCP服务器发现。DHCP客户使用255.255.255.255广播地址广播DHCP发现报文，使用IP地址为0.0.0.0
  2. DHCP服务器提供。DHCP服务器收到一个DHCP发现报文时，用DHCP提供报文向客户做出响应，同样将该报文广播到子网中的所有节点。
  3. DHCP请求。新到达的客户从一个或多个服务器提供中选择一个，并向选择的服务器提供DHCP请求报文进行响应，回显配置的参数。
  4. DHCP ACK。服务器用DHCP ACK报文对DHCP请求报文进行响应，证实所需要的参数。
+ 过程
  {{< img src="DHCP.png" alt="Rectangle" class="border-0" >}}

### 4.3.4 网络地址转换

+ 随着子网(家庭办公室等)的大量出现，为了简化分配IP地址的过程，使用 网络地址转换(NAT)
+ NAT使能路由器对于外部来说可以就是一个具有单一IP地址的单一设备，而其实际上对外部隐藏了内部网络的细节。
+ 内部网络使用的IP地址是RFC 1918中保留的IP地址空间之一，用于家庭网络等专用网络或者具有专用地址的地域(即其地址只对该网络中设备有意义)
+ 内部主机向外通信，发送源地址为主机IP地址，端口号随机生成的报文。
+ NAT使能路由器接收到报文，改变源地址为自身IP地址，生成一个不在NAT表中的端口号，发送报文，随后添加NAT表项。
+ 外部主机收到后，发送目的地址为路由器IP地址，端口号为路由器生成端口号的响应报文。
+ NAT使能路由器接收到响应报文，通过查NAT表，来转发给内部主机。
+ NAT路由器上有一张NAT转换表，表项中包含了端口号及其IP地址。
+ 过程
  {{< img src="NAT.png" alt="Rectangle" class="border-0" >}}

### 4.3.5 IPv6

#### 1. IPv6数据报格式

+ IPv6数据报格式
  {{< img src="IPv6.png" alt="Rectangle" class="border-0" >}}
+ 版本号：和IPv4类似，但是简单的改为4或6不能完成IPv4和IPv6的转换。
+ 流量类型(Traffic class): 含义和IPv4中服务类型类似，说明该数据报的类型。
+ 流标签(flow label)：用于标识一条数据报的流，对一条流中的某些数据报给出优先权。
+ 有效荷载长度：给出数据报中数据部分的长度。
+ 下一个首部：指出数据报中的数据部分应该交付到运输层的那个协议（TCP或者UDP）
+ 跳限制：和IPv4中寿命（TTL）用处一致。
+ 源/目的地址：从原来的32比特改为了128比特。
+ IPv6的首部长度为40字节。

#### 2. 从IPv4到IPv6的迁移

+ 在实践中已经得到广泛采用的IPv4到IPv6迁移的方法包括**建隧道**。
+ 将两台IPv6路由器之间的中间IPv5路由器的集合称为一个**隧道**，借助隧道，在隧道发送端的IPv6节点可将整个IPv6数据报放到一个IPv4数据报的数据字段中进行传输。
