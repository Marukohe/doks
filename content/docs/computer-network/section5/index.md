---
title: "第五章 网络层：控制平面"
description: ""
lead: ""
date: 2021-04-09T23:23:01+08:00
lastmod: 2021-04-09T23:23:01+08:00
draft: false
images: []
menu: 
  docs:
    parent: "computer-network"
weight: 11
toc: true
---

## 5.2 路由选择算法
+ 路由选择算法，其目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径。
+ 路由选择算法分类：
  - 集中式路由选择算法：链路状态算法（LS）
  - 分散式路由选择算法：距离向量算法（DV）
  - 静态路由选择算法
  - 动态路由选择算法
  - 负载敏感算法：链路开销会动态地变化以反映出底层地当前拥塞水平
  - 负载迟钝算法：现在因特网路由选择算法（RIP，OSPF，BGP）都是负载迟钝算法。

### 5.2.1 链路状态路由选择算法
+ 在该算法中，网络拓扑和所有链路开销都是已知的。实践中是通过让每个节点向网络中**广播链路状态分组**来完成的。其中链路状态分组包含和自己相连的链路的开销信息，这常常由**链路状态广播算法**完成。
+ 使用协议：OSPF，使用的算法：Dijkstra算法，复杂度$O(|V^2|)$
  ```C
  INF = 0x3fffffff
  Initialization: 
    N’ = {u} 
    for all nodes v 
      if v is a neighbor of u 
        then D(v) = c(u, v) 
      else D(v) = INF
  
   Loop
    find w not in N’ such that D(w) is a minimum 
    add w to N’ 
    update D(v) for each neighbor v of w and not in N’: 
         D(v) = min(D(v), D(w)+ c(w, v) ) 
    /* new cost to v is either old cost to v or known 
      least path cost to w plus cost from w to v */ 
   until N’= N
  ```
+ 链路状态算法运行过程
  {{< img src="LStable.png" alt="Rectangle" class="border-0" >}}
+ 存在的问题：拥塞敏感的选择震荡：
  - 在拥塞敏感且将路径负载当作开销的情况下，所有路由器同时运行LS算法，会使得由于选择了某一条目前最短开销路径而导致网络中路径开销改变，LS算法得出的最短开销路径会不断摇摆振荡。
  - 解决办法是**使每台路由器广播链路状态分组的时间随机化**。

### 5.2.2 距离向量路由选择算法
+ 该算法是一种迭代的、异步的、分布式的算法，使用的协议有BGP,RIP
+ 使用的算法：Bellman-ford算法，复杂度$O(|V||E|)$，算法关键$d_x(y)=min_v\{c(x,v)+d_v(y)\}$
+ DV算法的基本思想：
  - 初始计算自己的距离向量$D_x=[D_x(y):y\in N]$，发送自己的距离向量给相邻节点。
  - 保存相邻节点距离向量，并依据其更新自己的距离向量，再循环。
+ 算法运行过程
  {{< img src="DVtable.png" alt="Rectangle" class="border-0" >}}
+ 存在的问题：**无穷计数**
  - 当DV算法稳定后，网络中某条链路开销突然改变后，可能会出现路由选择环路，节点间的最短路径互相依赖，结果会在节点间不断来回变换，直到最后稳定，变换的次数和链路开销改变后的值相关，值足够大时会导致变换很多次，因此被称为无穷计数问题。
  - 解决方法：**毒性逆转**，即某一结点z到达x的最小开销路径的下一跳是y的话，z发送给y的信息中，z到x的最小开销为正无穷，使得此时y不可能通过依赖z来选择到达x的最小开销链路，从而避免无穷计数。当然毒性逆转并不能完全解决无穷计数问题，如作业题。

## 5.3 因特网中的自治系统内部的路由选择：OSPF
+ 在相同AS中的路由器都运行相同的路由选择算法并且有彼此的信息。在一个自治系统内运行的路由选择算法叫做自治系统内部路由选择协议
+ 使用洪泛链路状态信息和Dijkstra最低开销路径算法
+ 每一个路由器上都存储了一个含有整个自治系统网络信息的有向图，其中路由器，主机、子网都是节点，它们之间的关联作为图的边
+ 通过在本地运行LS算法，生成一个以自己为根的最短路径树
+ 路由表中存储目的节点，下一跳位置和距离
+ 使用OSPF时，路由器向自治系统内所有其他路由器广播路由选择信息
+ OSPF的优点：
  - 安全：所有OSPF消息都经过身份验证，以防止恶意入侵
  - 多条相同开销的路径：当存在多条相同开销的路径时，OSPF允许使用多条路径
  - 对单播和多播路由选择综合支持
  - 支持在单个AS的中的层次结构：在AS内部可以划分区域，每个区域运行自己的OSPF，然后由主干区域为其他区域之间流量提供路由选择

## 5.4 ISP之间的路由选择：BGP
+ BGP是一种**自治系统间路由选择协议**
### 5.4.1 BGP的作用
+ 在BPG中，分组并不是路由到一个特定的目的地址，相反是路由到CIDR化的前缀，其中每个前缀表示一个子网或一个子网的集合。一台路由器的转发表将路由形式为$(x,I)$的表项，其中$x$是一个前缀（例如138.16.68/22），$I$是该路由器的接口之一的接口号
+ BGP为每台路由器提供了一种完成以下任务的手段：
  - 从邻居AS获得前缀的可达性信息
  - 确定到该前缀的“最好的”路由

### 5.4.2 通告BGP路由信息
+ 每台路由器要么是一台**网关路由器**，要么是一台**内部路由器**
+ 在BGP中，每台路由器通过使用179端口的半永久TCP连接交换路由选择信息
+ 跨越两个AS的BGP连接称为外部BGP（eBGP）连接
+ 在相同AS中的两台路由器之间的BGP会话称为内部BGP（iBGP）连接

### 5.4.3 确定最好的路由
+ 当BGP通告前缀时，它在前缀中包括一些**BGP属性**。两个较为重要的属性是AS-PATH和NEXT-HOP。
+ 当一个前缀通过某个AS时，该AS会在该前缀的AS-PATH上加上自己的AS Number。BGP路由器可以使用AS-PATH属性来检测和防止通告换路；特别是，如果一台路由器在路径列表中看到包含了它自己的AS，它将拒绝该通告。
+ NEXT-HOP是AS-PATH起始的路由器接口的IP地址。

#### 1. 热土豆路由选择
+ 每台路由器尽可能快的将分组送出其AS，而不担心其AS外部到目的地余下部分的开销。

#### 2. 路由器选择算法
+ 如果到相同前缀有两条或多条路由，则顺序的调用下列消除规则直到余下一条路由。
  1. 路由被指派一个**本地偏好**值作为其属性值一。具有最高本地偏好值得路由器将被选择。
  2. 从余下得路由中，将选择具有最短AS-PATH的路由。
  3. 从余下的路由中，使用热土豆路由选择，即选择具有最靠近NEXT-HOP路由器的路由。
  4. 如果仍留下多条路由，该路由器使用BGP标识符来选择路由。

### 5.4.4 IP任播
+ BGP常被用于实现IP任播服务。可用于DNS服务和CDN。

### 5.4.5 路由选择策略
+ 所有进入一个接入ISP网络的流量必定是以该网络为目的地，所有离开一个接入ISP网络的流量必定源于该网络。

## 5.6 ICMP：因特网控制报文协议
+ 由[RFC 972]定义的因特网控制报文协议（ICMP），被主机和路由器用来彼此沟通网络层信息。ICMP最典型的用途是差错报告。
+ ICMP通常被认为是IP的一部分，但从体结构上讲它位于IP之上，因为ICMP报文是承载在IP分组中的。（上层协议编码为1）
+ ICMP报文有一个类型字段和一个编码字段，并且包含引起该ICMP报文首次生成的IP数据报的首部和前8个字节。
+ **ping的实现**：ping程序发送一个ICMP类型8编码0的报文到指定主机。看到回到请求，目的主机发回一个类型0编码0的ICMP回显回答。大多数TCP/IP实现直接在操作系统中支持ping服务器，即该服务器不是一个进程。
+ **Traceroute程序**使用ICMP报文实现：源主机中的Traceroute向目的主机发送一系列普通的IP数据报。这些数据的每个携带了一个不可到达UDP端口号的UDP报文短。第一个数据报的TTL为1，第二个的TTL为2，第n个的TTL为n。当第n个数据报到达第n个路由器时，第n台路由器观察到这个数据报的TTL正好过期。根据IP协议规则，路由器丢弃该数据报并发送一个ICMP警告报文给源主机（类型11编码0）。该告警报文包含了路由器的名字和它的IP地址。当该ICMP报文返回源主机时，源主机从定时器得到往返时延，从ICMP报文中得到第$n$台路由器的名字与IP地址。

